%h3 List of Parameter Sets
%table.table.table-condensed.table-striped.table-hover#param_list{:'data-source' => "#{_parameter_list_simulator_path(@simulator.to_param, format: "json", query_id: @query_id)}"}
  %thead
    %tr
      %th.span1 Rans Progress
      - @simulator.parameter_definitions.each do |key,key_def|
        %th.span1= key
  %tbody

%a.btn.btn-primary{href: new_simulator_parameter_set_path(@simulator)}
  New Parameter Set
  
- if @query_list
  %h4 Select query
  = form_for(@simulator, :url=>{:controller=>"simulators", :action=>"show"}, :html => { :method => :get } ) do |f|
    = select_tag "query_id", options_for_select(@query_list, @query_id), :prompt => "all"
    = f.submit "Apply query", :class => 'btn btn-primary', :name => nil

%h4 Make query
= form_tag( _make_query_simulator_path(@simulator) ) do |f|
  %table
    %tbody
      %tr
        %td
          "Key"
        %td
          "Matcher"
        %td
          "Value"
      %tr#queries_form_original
        %td#select_param_form
          = select_tag "query[][param]", options_for_select(@simulator.parameter_definitions)
        %td#select_matcher_form
          = select_tag "query[][matcher]", options_for_select({""=>""})
        %td#select_value_form
          = text_field_tag "query[][value]"
  .controls
    .btn#add_queries_form Add more query
  = hidden_field_tag "query_id", @query_id
  = submit_tag "Make query", :class => 'btn btn-primary'

- unless @query_id.blank?
  %h4 Delete query
  = form_tag( _make_query_simulator_path(@simulator) ) do |f|
    = hidden_field_tag "query_id", @query_id
    = submit_tag "Delete query", :class => 'btn btn-primary', :name => :delete_query

:javascript
  $(function() {
    $('#add_queries_form').click(function() {
      var cloned = $('#queries_form_original').clone();
      $('#add_queries_form').before($(cloned));
      $("select" ,cloned).trigger("change");
    });
  });

  $(function() {
    $("body").on("change", "#select_param_form select", function(){
      $("#select_matcher_form option",$(this).parent().parent()).remove()
      var matcher_form_selector = $("#select_matcher_form",$(this).parent().parent())
      var matcher_val;
      var matcher_text;
      if($(":selected",this).attr('type') == "Integer" || $(":selected",this).attr('type') == "Float") {
        matcher_val = #{raw ParameterSetQuery::NumTypeMatchers.to_json};
        matcher_text = #{raw ParameterSetQuery::NumTypeMatcherStrings.to_json};
      } else if($(":selected",this).attr('type') == "Boolean") {
        matcher_val = #{raw ParameterSetQuery::BooleanTypeMatchers.to_json};
        matcher_text = #{raw ParameterSetQuery::BooleanTypeMatchers.to_json};
      } else if($(":selected",this).attr('type') == "String") {
        matcher_val = #{raw ParameterSetQuery::StringTypeMatchers.to_json};
        matcher_text = #{raw ParameterSetQuery::StringTypeMatchers.to_json};
      }

      for(i in matcher_val){
        $("select",matcher_form_selector).append("<option value=\"\"></option>");
        $("option:nth-child("+(parseInt(i)+1)+")",matcher_form_selector).val(matcher_val[i]).text(matcher_text[i]);
      }

      var value_form_selector = $("#select_value_form",$(this).parent().parent())
      $("input",value_form_selector).remove()
      value_form_selector.append("<input id=\"query__value\" name=\"query[][value]\" type=\"text\" value="+ $(":selected",this).attr('default') +">")
    });
  });

  $(function() {
    var parameter_form_selector = $("#select_param_form select")
    parameter_form_selector.val("#{@simulator.parameter_definitions.keys[0]}");
    parameter_form_selector.trigger("change");
  });

  var param_list_table_width = $("#param_list").width()

:coffeescript
jQuery ->
  $('#param_list').dataTable
    bProcessing: true
    bServerSide: true
    bFilter: false
    sAjaxSource: $('#param_list').data('source')
    sDom: "<'row-fluid'<'span6'l><'span6'f>r>t<'row-fluid'<'span6'i><'span6'p>>"
    sPaginationType: "bootstrap"
    fnDrawCallback: (oSettings)->
      $("tbody", this).append($("<tr>").html($("<td>").attr({colspan: "3"})))
      $("tbody > tr", this).each (i, parent_element)->
        if $("a", parent_element).length
          element = $("a", parent_element)
          if $("img", parent_element).length == 0
            $(element).before($("<img>")
              .attr("id", "treebtn")
              .attr("src", "/assets/expand.png")
              .attr("align", "left")
              .attr("style", "margin-right: 5px;")
              .attr("dialog", "close"))
          param_id = $(element).attr("href").substr($(element).attr("href").lastIndexOf("/")+1)
          $(element).text("")
          $.getJSON "/parameter_sets/"+param_id+"/_runs_count", (runs)->
            if runs.total > 0
              $(element).append($("<div>").addClass("progress"))
              div_element = $("div",element)
              if runs.finished > 0
                $(div_element).append($("<span>").addClass("progress progress-success progress-striped active"))
                percent = Math.floor(100.0*runs.finished/runs.total)
                $("span.progress.progress-success.progress-striped.active", div_element)
                  .append($("<span>").addClass("bar").attr({style: "width: "+percent+"%"}).text(percent+"%"))
              if runs.running > 0
                $(div_element).append($("<span>").addClass("progress progress-warning progress-striped active"))
                percent = Math.floor(100.0*runs.running/runs.total)
                $("span.progress.progress-warning.progress-striped.active", div_element)
                  .append($("<span>").addClass("bar").attr({style: "width: "+percent+"%"}).text(percent+"%"))
              if runs.failed > 0
                $(div_element).append($("<span>").addClass("progress progress-danger progress-striped active"))
                percent = Math.floor(100.0*runs.failed/runs.total)
                $("span.progress.progress-danger.progress-striped.active", div_element)
                  .append($("<span>").addClass("bar").attr({style: "width: "+percent+"%"}).text(percent+"%"))
            else
              $(element).append(param_id)

jQuery ->
  $("body").on "click", "img#treebtn", ->
    if ($(this).attr("dialog") == "close")
      td_element = $(this).parent()
      next_td_element = $(this).parent().parent().next()
      param_id = $("a", td_element).attr("href").substr($("a", td_element).attr("href").lastIndexOf("/")+1)
      $(this)
        .attr("dialog", "open")
        .attr("src", "/assets/collapse.png")
      $.get "/parameter_sets/"+param_id+"/_runs_table", (data) ->
        next_td_element.before($("<tr>").attr("id", "inline_run").html($("<td>").attr({colspan: "3"}).html(data)))
    else
      $(this)
        .attr("dialog", "close")
        .attr("src", "/assets/expand.png")
      while ($(this).parent().parent().next().attr("id") == "inline_run")
        $(this).parent().parent().next().remove()