==========================================
高度な使い方
==========================================

スケジューラを経由してジョブを実行する
==========================================

| ジョブスケジューラー（Torqueなど）を経由してジョブを実行する方法について説明する。
| Host登録時にジョブスケジューラを指定する事にって、スケジューラのジョブ投入コマンド経由でジョブが実行されるようになる。
| 現在サポートされているスケジューラはTorqueとPJM(Fujitsu FX10で採用されているジョブスケジューラ)のみである。
| 以降ではTorqueにジョブを投げるケースを想定して説明する。

スクリプトのヘッダに特別な指定がいらないケース
----------------------------------------------

| シングルスレッド、シングルプロセスのジョブでスクリプトのヘッダに特別な記述が必要ない場合は、Hostの登録時にスケジューラタイプとして *Torque* を選択するだけでよい。
| このようにセットしておけば、workerがジョブスクリプトをqsubコマンドで実行し、その際に取得したTorqueのジョブIDを記録する。
| workerは定期的に qstat コマンドで得られた結果をパースしてジョブの状態をモニターし、ジョブの完了後に計算結果を取得する。
| 実行中に異常終了した場合、途中までの結果をサーバーにダウンロードしRunのステータスを *failed* として記録する。
| 実行中にユーザーによってRunが削除された場合は、qdelコマンドを使用してジョブを停止させる。

| PJMの場合には pjsub, pjstat, pjdel コマンドを使用してジョブの管理を行う。

スクリプトのヘッダに変数を指定するケース
----------------------------------------------

| スクリプトのヘッダにスケジューラのパラメータ（使用時間、占有するノード数、使用メモリ量など）を指定する必要があるケースについて説明する。
| ここでは例としてMPIで並列化しているシミュレーターを、Torqueのスケジューラを使って占有時間を指定して実行することを考える。

| スクリプトのヘッダに指定する変数は以下のようになる。
.. code-block:: sh

  #!/bin/bash
  #PBS -l nodes=2:ppn=4
  #PBS -l walltime=10:00
  ...

| ここでnodesが使用するノード数、ppnは各ノード内のプロセス数、walltimeが実行制限時間である。
| 各ジョブによってこれらの値が異なるため、Runの作成時にこれらの値を指定できるようにしたい。

| そのためにはホストパラメータと呼ぶ仕組みを使用する。
| ホストパラメータとして指定した変数は各Runの作成時に個別に入力することができ、その変数がホストのテンプレート部分に展開される。

| 具体的には以下の手順でHostの "template", "Definition of Host Parameters" というフィールドを設定する。
1. templateの変数展開をしたい部分を *<%= ... %>* という記号で囲む。今回の例ではヘッダ部分を以下のように編集する。
  .. code-block:: sh

    #!/bin/bash
    #PBS -l nodes=<%= nodes %>:ppn=<%= ppn %>
    #PBS -l walltime=<%= walltime %>
    ...

2. "Definition of Host Parameter"の部分に展開したい変数の変数名、デフォルト値、フォーマット（入力可能な形式を正規表現で指定）を入力する。
  今回の場合、以下のように設定する。（formatの部分は空でもよいが、設定しておくとRunの作成時に不正な値を入れるとエラーになるのでミスに気づきやすくなる。）

  * Name: nodes,    Default: 1, format: ^\d+$
  * Name: ppn,      Default: 1, format: ^\d+$
  * Name: walltime, Default: 10:00, format: ^(\d\d:)?\d\d:\d\d$

  .. image:: images/edit_host_template.png
    :width: 50%
    :align: center

  | この際、テンプレートとホストパラメータ定義が整合していないとエラーとなる。
  | テンプレートで展開する変数は必ずホストパラメータとして定義されている必要があり、ホストパラメータとして定義された変数はテンプレート中に現れなくてはならない。

| 以上でホストの設定は完了である。
| この設定後、Runの作成時に以下のようにホストパラメータを入力する箇所が現れる。

.. image:: images/new_run_with_host_params.png
  :width: 30%
  :align: center

MPI, OpenMPのジョブ並列数をスクリプトのヘッダに指定するケース
-------------------------------------------------------------

- MPIの実行方法を変更したい場合

プリプロセスの定義
==============================================


Analyzerの登録と実行
==============================================
